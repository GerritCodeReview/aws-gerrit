{
  "comments": [
    {
      "key": {
        "uuid": "f7f97a32_c3790717",
        "filename": "gerrit/Dockerfile",
        "patchSetId": 11
      },
      "lineNbr": 1,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-04-10T09:46:07Z",
      "side": 1,
      "message": "Can you mention this in the commit message and the rationale behind it?",
      "range": {
        "startLine": 1,
        "startChar": 29,
        "endLine": 1,
        "endChar": 42
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "608535bf_988cf858",
        "filename": "gerrit/Dockerfile",
        "patchSetId": 11
      },
      "lineNbr": 1,
      "author": {
        "id": 1054778
      },
      "writtenOn": "2020-04-10T16:00:03Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "f7f97a32_c3790717",
      "range": {
        "startLine": 1,
        "startChar": 29,
        "endLine": 1,
        "endChar": 42
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "53831306_527b5554",
        "filename": "gerrit/add_secrets_aws_secrets_manager.sh",
        "patchSetId": 11
      },
      "lineNbr": 45,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-04-10T09:46:07Z",
      "side": 1,
      "message": "This can be a unique for/loop statement, avoiding the copy\u0026paste multiple times and making more readable.",
      "range": {
        "startLine": 15,
        "startChar": 0,
        "endLine": 45,
        "endChar": 66
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f91ef769_283cebf8",
        "filename": "gerrit/add_secrets_aws_secrets_manager.sh",
        "patchSetId": 11
      },
      "lineNbr": 45,
      "author": {
        "id": 1054778
      },
      "writtenOn": "2020-04-10T16:00:03Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "53831306_527b5554",
      "range": {
        "startLine": 15,
        "startChar": 0,
        "endLine": 45,
        "endChar": 66
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "48da4d9e_1fb6969a",
        "filename": "gerrit/entrypoint.sh",
        "patchSetId": 11
      },
      "lineNbr": 23,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-04-10T09:46:07Z",
      "side": 1,
      "message": "How can we be sure that 5 minutes is enough?\nI believe we should rather check if the minimum repos needed by Gerrit have been replicated, All-Projects and All-Users.",
      "range": {
        "startLine": 22,
        "startChar": 0,
        "endLine": 23,
        "endChar": 11
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e5f7d928_3f174822",
        "filename": "gerrit/entrypoint.sh",
        "patchSetId": 11
      },
      "lineNbr": 23,
      "author": {
        "id": 1054778
      },
      "writtenOn": "2020-04-10T16:00:03Z",
      "side": 1,
      "message": "it is hard to coordinate the replication..I thought a basic sleep of 5 min (which is enough in case of not many repos) would be enough as a starting point.\n\nJust checking for the existence of All-* repos wouldn\u0027t be enough, since, when the repo doesn\u0027t exists at all, it gets created first and in the next replication cycle the refs will be replicated.\n\nWe would need a way to make sure all the refs for the All-* repos have been replicated. Any suggestion on how to do it?",
      "parentUuid": "48da4d9e_1fb6969a",
      "range": {
        "startLine": 22,
        "startChar": 0,
        "endLine": 23,
        "endChar": 11
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d85a92be_9084dd83",
        "filename": "gerrit/entrypoint.sh",
        "patchSetId": 11
      },
      "lineNbr": 23,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-04-14T14:23:59Z",
      "side": 1,
      "message": "For Gerrit to start, you need the following two repos and refs:\nAll-Projects/refs/meta/{config,version}\nAll-Users/refs/meta/external-ids\n\nYou can just check if they exist and, if they don\u0027t, just exit and rely on ECS to reschedule your startup.",
      "parentUuid": "e5f7d928_3f174822",
      "range": {
        "startLine": 22,
        "startChar": 0,
        "endLine": 23,
        "endChar": 11
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "828422ac_1efff3b7",
        "filename": "gerrit/entrypoint.sh",
        "patchSetId": 11
      },
      "lineNbr": 23,
      "author": {
        "id": 1054778
      },
      "writtenOn": "2020-04-14T17:10:15Z",
      "side": 1,
      "message": "I can leave ECS rescheduling the startup. I need an inited instance to replicate to. See my description of the different scenarios:\n\nCURRENT SITUATION:\n* if All-Projects.git doesn\u0027t exists, init Slave and remove All-*.git\n* sleep for 5 min waiting for master to replicate\n* after 5 min, start Slave with synched All-*.git\n\nThis relies on assuming that 5 min is enough to replicate, which is true for a small installation.\n\nLEAVE ECS TO RESCHEDULE STARTUP:\n* if All-Projects.git doesn\u0027t exists, init Slave and remove All-*.git\n* check for All-Projects/refs/meta/{config,version} and All-Users/refs/meta/external-ids, if it doesn\u0027t exist startup again\n\nThe problem with this approach is that it might happen that replication happens while restarting the slave.\nIn this case, the next restart of the slave would skip the init phase, which is fundamental.\n\nWAIT FOR REPLICATION TO HAPPEN:\nWhat I am suggesting is an in-between solution, where, instead of sleeping for a fixed amount of time, we keep checking on the slave for All-Projects/refs/meta/{config,version} and All-Users/refs/meta/external-ids to be populated.\n\nOnce they are present we startup the slave.\n\nWDYT?",
      "parentUuid": "d85a92be_9084dd83",
      "range": {
        "startLine": 22,
        "startChar": 0,
        "endLine": 23,
        "endChar": 11
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5ec2634b_8c91f5ea",
        "filename": "gerrit/entrypoint.sh",
        "patchSetId": 11
      },
      "lineNbr": 23,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-04-15T09:50:18Z",
      "side": 1,
      "message": "\u003e LEAVE ECS TO RESCHEDULE STARTUP:\n\u003e * if All-Projects.git doesn\u0027t exists, init Slave and remove All-*.git\n\u003e * check for All-Projects/refs/meta/{config,version} and All-Users/refs/meta/external-ids, if it doesn\u0027t exist startup again\n\u003e \n\u003e The problem with this approach is that it might happen that replication happens while restarting the slave.\n\u003e In this case, the next restart of the slave would skip the init phase, which is fundamental.\n\nWhy is the init phase fundamental for a slave? Gerrit slaves do not need any init, but only a reindex of Groups, of course if the All-Users.git repository is there.\n\n\u003e WAIT FOR REPLICATION TO HAPPEN:\n\u003e What I am suggesting is an in-between solution, where, instead of sleeping for a fixed amount of time, we keep checking on the slave for All-Projects/refs/meta/{config,version} and All-Users/refs/meta/external-ids to be populated.\n\nThat is actually an anti-pattern, we should leave to the container manager the task to reschedule the instances and not make artificial sleeps in the code.",
      "parentUuid": "828422ac_1efff3b7",
      "range": {
        "startLine": 22,
        "startChar": 0,
        "endLine": 23,
        "endChar": 11
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "86335b21_ba45ffe2",
        "filename": "gerrit/entrypoint.sh",
        "patchSetId": 11
      },
      "lineNbr": 25,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-04-10T09:46:07Z",
      "side": 1,
      "message": "This looks redundant.",
      "range": {
        "startLine": 25,
        "startChar": 23,
        "endLine": 25,
        "endChar": 41
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f4e354b1_fc8222b8",
        "filename": "gerrit/entrypoint.sh",
        "patchSetId": 11
      },
      "lineNbr": 25,
      "author": {
        "id": 1054778
      },
      "writtenOn": "2020-04-10T16:00:03Z",
      "side": 1,
      "message": "yep it was just a debugging print.",
      "parentUuid": "86335b21_ba45ffe2",
      "range": {
        "startLine": 25,
        "startChar": 23,
        "endLine": 25,
        "endChar": 41
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "9d9f71e3_cffa26ef",
        "filename": "gerrit/entrypoint.sh",
        "patchSetId": 11
      },
      "lineNbr": 29,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-04-10T09:46:07Z",
      "side": 1,
      "message": "This should only be done for the slave, isn\u0027t it?",
      "range": {
        "startLine": 29,
        "startChar": 0,
        "endLine": 29,
        "endChar": 59
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8afe2b3e_2db45f1f",
        "filename": "gerrit/entrypoint.sh",
        "patchSetId": 11
      },
      "lineNbr": 29,
      "author": {
        "id": 1054778
      },
      "writtenOn": "2020-04-10T16:00:03Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "9d9f71e3_cffa26ef",
      "range": {
        "startLine": 29,
        "startChar": 0,
        "endLine": 29,
        "endChar": 59
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "ede76287_44f0d496",
        "filename": "gerrit/etc/replication.config.template",
        "patchSetId": 11
      },
      "lineNbr": 9,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-04-10T09:46:07Z",
      "side": 1,
      "message": "We have only 1 slave, so it should be \u0027slave\u0027, correct?",
      "range": {
        "startLine": 9,
        "startChar": 9,
        "endLine": 9,
        "endChar": 16
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "751adc38_ae3b3813",
        "filename": "gerrit/etc/replication.config.template",
        "patchSetId": 11
      },
      "lineNbr": 9,
      "author": {
        "id": 1054778
      },
      "writtenOn": "2020-04-10T16:00:03Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "ede76287_44f0d496",
      "range": {
        "startLine": 9,
        "startChar": 9,
        "endLine": 9,
        "endChar": 16
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f7f6442e_e845c98a",
        "filename": "gerrit/setup_gerrit.py",
        "patchSetId": 11
      },
      "lineNbr": 92,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-04-10T09:46:07Z",
      "side": 1,
      "message": "Replication",
      "range": {
        "startLine": 92,
        "startChar": 18,
        "endLine": 92,
        "endChar": 29
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c20bca7d_78c6c5bb",
        "filename": "gerrit/setup_gerrit.py",
        "patchSetId": 11
      },
      "lineNbr": 92,
      "author": {
        "id": 1054778
      },
      "writtenOn": "2020-04-10T16:00:03Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "f7f6442e_e845c98a",
      "range": {
        "startLine": 92,
        "startChar": 18,
        "endLine": 92,
        "endChar": 29
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "a21cef90_39563ba8",
        "filename": "gerrit/setup_gerrit.py",
        "patchSetId": 11
      },
      "lineNbr": 135,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-04-10T09:46:07Z",
      "side": 1,
      "message": "This template is a simple master-slave scenario, this comment isn\u0027t needed at the moment IMHO.",
      "range": {
        "startLine": 135,
        "startChar": 0,
        "endLine": 135,
        "endChar": 84
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7081708a_9e43cc3c",
        "filename": "gerrit/setup_gerrit.py",
        "patchSetId": 11
      },
      "lineNbr": 135,
      "author": {
        "id": 1054778
      },
      "writtenOn": "2020-04-10T16:00:03Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "a21cef90_39563ba8",
      "range": {
        "startLine": 135,
        "startChar": 0,
        "endLine": 135,
        "endChar": 84
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "869c0358_994277fa",
        "filename": "master-slave/Makefile",
        "patchSetId": 11
      },
      "lineNbr": 10,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-04-10T09:46:07Z",
      "side": 1,
      "message": "nit only one tab for indentation would suffice.",
      "range": {
        "startLine": 10,
        "startChar": 0,
        "endLine": 10,
        "endChar": 4
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fdf83443_ebd18003",
        "filename": "master-slave/Makefile",
        "patchSetId": 11
      },
      "lineNbr": 10,
      "author": {
        "id": 1054778
      },
      "writtenOn": "2020-04-10T16:00:03Z",
      "side": 1,
      "message": "it looks better indented this way IMO. Have a look at the file in a code editor.",
      "parentUuid": "869c0358_994277fa",
      "range": {
        "startLine": 10,
        "startChar": 0,
        "endLine": 10,
        "endChar": 4
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "efd3783d_9944e2d3",
        "filename": "master-slave/Makefile",
        "patchSetId": 11
      },
      "lineNbr": 10,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-04-14T14:23:59Z",
      "side": 1,
      "message": "OK, but then you need to wrap them because they overflow at the moment :-(",
      "parentUuid": "fdf83443_ebd18003",
      "range": {
        "startLine": 10,
        "startChar": 0,
        "endLine": 10,
        "endChar": 4
      },
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b6a77646_aed22282",
        "filename": "master-slave/README.md",
        "patchSetId": 11
      },
      "lineNbr": 3,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-04-10T09:46:07Z",
      "side": 1,
      "message": "nit: extra empty line.",
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e607b007_2cac59e2",
        "filename": "master-slave/README.md",
        "patchSetId": 11
      },
      "lineNbr": 3,
      "author": {
        "id": 1054778
      },
      "writtenOn": "2020-04-10T16:00:03Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "b6a77646_aed22282",
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "4d13933f_bb2a1ec5",
        "filename": "master-slave/git-ssh/setup_ssh.py",
        "patchSetId": 11
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-04-10T09:46:07Z",
      "side": 1,
      "message": "De we really need to get the secrets ourselves manually with Python? According to the AWS documentation, ECS provides the secrets out of the box:\nhttps://docs.aws.amazon.com/AmazonECS/latest/developerguide/specifying-sensitive-data.html",
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1f94c8df_9c7584ec",
        "filename": "master-slave/git-ssh/setup_ssh.py",
        "patchSetId": 11
      },
      "lineNbr": 0,
      "author": {
        "id": 1054778
      },
      "writtenOn": "2020-04-10T16:16:48Z",
      "side": 1,
      "message": "In this case I think it is better to get them since anyway we will need some code to persist them on the file system.\n\nFurthermore, the `get_secret` function you see, is the official one provided by AWS, hence I believe it is a stable piece of code and it is one of the suggested way of retrieving the secrets.\n\nIf we were to use, for example, a token or a password that doesn\u0027t require to be persisted on file system, it would have been better injecting them as \"secret environment variables\" as you suggested.",
      "parentUuid": "4d13933f_bb2a1ec5",
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6172e216_827a8e63",
        "filename": "master-slave/git-ssh/setup_ssh.py",
        "patchSetId": 11
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-04-14T14:23:59Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "1f94c8df_9c7584ec",
      "revId": "f4f89fa655911162228c056535cd180906ca9d7a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}