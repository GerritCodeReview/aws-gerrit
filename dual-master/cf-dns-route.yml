AWSTemplateFormatVersion: '2010-09-09'
Description: A stack for the Gerrit service Route53 routing.
Parameters:
  Master1ServiceStackName:
      Description: Stack name of the ECS Master Gerrit service
      Type: String
      Default: gerrit-service-master-1
  Master2ServiceStackName:
      Description: Stack name of the ECS Master Gerrit service
      Type: String
      Default: gerrit-service-master-2
  SlaveServiceStackName:
      Description: Stack name of the ECS Slave Gerrit service
      Type: String
      Default: gerrit-service-slave
  LBServiceStackName:
      Description: Stack name of the ECS LB service
      Type: String
      Default: gerrit-service

Resources:
  Master1DnsRecord:
      Type: AWS::Route53::RecordSet
      Properties:
        Name:
          !Join
            - '.'
            - - Fn::ImportValue: !Join [':', [!Ref 'Master1ServiceStackName', 'Subdomain']]
              - Fn::ImportValue: !Join [':', [!Ref 'Master1ServiceStackName', 'HostedZoneName']]
        HostedZoneName:
          !Join
            - ''
            - - Fn::ImportValue: !Join [':', [!Ref 'Master1ServiceStackName', 'HostedZoneName']]
              - '.'
        Comment: DNS name for Gerrit Master.
        Type: A
        AliasTarget:
          DNSName:
            Fn::ImportValue:
              !Join [':', [!Ref 'Master1ServiceStackName', 'PublicLoadBalancerDNSName']]
          HostedZoneId:
            Fn::ImportValue:
              !Join [':', [!Ref 'Master1ServiceStackName', 'CanonicalHostedZoneID']]
          EvaluateTargetHealth: False
  Master2DnsRecord:
      Type: AWS::Route53::RecordSet
      Properties:
        Name:
          !Join
            - '.'
            - - Fn::ImportValue: !Join [':', [!Ref 'Master2ServiceStackName', 'Subdomain']]
              - Fn::ImportValue: !Join [':', [!Ref 'Master2ServiceStackName', 'HostedZoneName']]
        HostedZoneName:
          !Join
            - ''
            - - Fn::ImportValue: !Join [':', [!Ref 'Master2ServiceStackName', 'HostedZoneName']]
              - '.'
        Comment: DNS name for Gerrit Master.
        Type: A
        AliasTarget:
          DNSName:
            Fn::ImportValue:
              !Join [':', [!Ref 'Master2ServiceStackName', 'PublicLoadBalancerDNSName']]
          HostedZoneId:
            Fn::ImportValue:
              !Join [':', [!Ref 'Master2ServiceStackName', 'CanonicalHostedZoneID']]
          EvaluateTargetHealth: False
  LBDnsRecord:
      Type: AWS::Route53::RecordSet
      Properties:
        Name:
          !Join
            - '.'
            - - Fn::ImportValue: !Join [':', [!Ref 'LBServiceStackName', 'Subdomain']]
              - Fn::ImportValue: !Join [':', [!Ref 'LBServiceStackName', 'HostedZoneName']]
        HostedZoneName:
          !Join
            - ''
            - - Fn::ImportValue: !Join [':', [!Ref 'LBServiceStackName', 'HostedZoneName']]
              - '.'
        Comment: DNS name for Gerrit LB.
        Type: A
        AliasTarget:
          DNSName:
            Fn::ImportValue:
              !Join [':', [!Ref 'LBServiceStackName', 'PublicLoadBalancerDNSName']]
          HostedZoneId:
            Fn::ImportValue:
              !Join [':', [!Ref 'LBServiceStackName', 'CanonicalHostedZoneID']]
          EvaluateTargetHealth: False

Outputs:
  Master1CanonicalWebUrl:
    Description: Master1 Canonical Web Url
    Value:
      Fn::ImportValue: !Join [':', [!Ref 'Master1ServiceStackName', 'CanonicalWebUrl']]
    Export:
      Name: !Join [ ':', [ !Ref 'AWS::StackName', 'Master1CanonicalWebUrl' ] ]
  Master2CanonicalWebUrl:
    Description: Master2 Canonical Web Url
    Value:
      Fn::ImportValue: !Join [':', [!Ref 'Master2ServiceStackName', 'CanonicalWebUrl']]
    Export:
      Name: !Join [ ':', [ !Ref 'AWS::StackName', 'Master2CanonicalWebUrl' ] ]
  SlaveCanonicalWebUrl:
    Description: Slave Canonical Web Url
    Value:
      Fn::ImportValue: !Join [':', [!Ref 'SlaveServiceStackName', 'CanonicalWebUrl']]
    Export:
      Name: !Join [ ':', [ !Ref 'AWS::StackName', 'SlaveCanonicalWebUrl' ] ]
